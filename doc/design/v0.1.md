# 🚀 SourceBridge 项目设计文档 (v0.1)

> **项目名称**：SourceBridge
> **版本**：v0.1
> **日期**：2025-12-18
> **项目类型**：跨环境 Git 搬运与同步工具
> **技术栈**：Tauri v2 + Rust + Vue 3

---

## 🧭 一、项目概述

**SourceBridge** 是一个基于 **Tauri v2 + Rust** 构建的现代化跨平台 Git 代码同步与桥接系统。旨在解决“有外网的主库”与“内网隔离的从库”之间代码搬运的痛点，提供安全、高效、可视化的代码同步方案。

v0.1 版本综合了**多仓库管理与分组**、**任务编排调度**以及精细化路径映射等核心能力，利用 Rust 强大的性能优势，打造一个高性能、低资源占用的“仓库网络管理”工具。

### 🔹 核心目标
- **极致性能**：使用 Rust 处理所有 I/O、Git 操作与差异计算，速度飞快。
- **跨平台原生体验**：MacOS / Windows / Linux 完美支持，兼容 Win7。
- **双模操作**：CLI + GUI 双模式。
- **多层级管理**：支持 Git 仓库分组、路由分组，结构清晰。
- **任务编排**：支持自定义任务流（脚本执行 -> 仓库更新 -> 路由搬运 -> 提交推送），可定时执行。
- **精细映射**：支持子目录、单文件、多文件、通配符级别的路径映射。
- **国际化 (i18n)**：原生支持多语言（中文/English），跟随系统或手动设置。
- **可视化差异**：同步前提供 GitHub-like 的差异比对 (Diff) 预览。

---

## ⚙️ 二、技术栈

| 层级          | 技术选型                        | 说明                                                              |
| ------------- | ------------------------------- | ----------------------------------------------------------------- |
| **UI 前端**   | **Vue 3 + TypeScript**          | 结合 TailwindCSS + ShadcnUI 构建现代化界面                        |
| **国际化**    | **vue-i18n**                    | 处理前端多语言文案                                                |
| **状态管理**  | **TanStack Query / Pinia**      | 负责前端状态与后端数据同步                                        |
| **应用框架**  | **Tauri v2**                    | 负责窗口管理、原生菜单、系统托盘、自动更新                        |
| **核心后端**  | **Rust (compat)**               | 处理所有业务逻辑，**需兼容 Win7 (Rust <=1.75 或 tier 3 targets)** |
| **Windows 7** | **WebView2 Fixed/Bootstrapper** | Win7 需内嵌 WebView2 安装程序或使用 Fixed Version                 |
| **Git 操作**  | **git2-rs / std::process**      | 调用 libgit2 或本地 Git 命令                                      |
| **差异算法**  | **similar (Rust crate)**        | 高性能文本差异比对算法                                            |
| **数据库**    | **SQLite (rusqlite / sqlx)**    | 本地持久化存储，Rust 直接读写                                     |
| **调度器**    | **tokio-cron-scheduler**        | Rust 异步运行时中的定时任务系统                                   |

---

## 🧩 三、系统架构

```text
+-------------------------------------------------------+
|                 SourceBridge GUI Window               |
|      [Task Builder UI] [Route Manager] [Console]      |
+---------------------------+---------------------------+
                            |
                   (Rust Backend / Tauri)
                            v
+-------------------------------------------------------+
| Task Orchestrator (New)                   |
| ----------------------------------------- |
| 1. Scheduler (Cron Trigger)               |
| 2. Pipeline Runner (Sequential Execution) |
| ├── Step: Shell Script                    |
| ├── Step: Git Operation (Pull/Push)       |
| └── Step: Sync Route (Execute Mapping)    |
+-------------------------------------------------------+
                            |
                   (Core Modules)
                            v
+-------------+      +-------------+      +-------------+
| Repo Manager|      | Route Engine|      | Diff Engine |
| + Groups    |      | + Groups    |      |             |
+-------------+      +-------------+      +-------------+
```

---

## 🧱 四、核心功能模块

### 1️⃣ 仓库与分组管理 (Repository & Groups)
- **RepoManager**: 管理 Git 仓库的基础信息与认证（SSH/Token）。
- **GroupManager**: 
    - 支持无限层级分组。
    - 仓库可归属于分组，方便组织（如：公司A/项目B/后端库）。

### 2️⃣ 路线与映射管理 (Routes & Mappings)
- **分组结构**：Route 支持分组管理，将相关的同步路线聚合。
- **纯粹化设计**：Route 不再包含调度信息，仅定义“从哪搬到哪”及其映射规则。
- **功能**：
    - 定义源路径与目标路径。
    - 定义文件过滤与映射规则（Glob/File）。
    - 提供 Diff 预览的基础数据。

### 3️⃣ 任务编排与调度 (Task Orchestrator)
- **概念**：一个“任务 (Task)”是一个有序的动作序列 (Pipeline)。
- **动作类型 (Step Types)**：
    1.  `run_script`: 执行用户自定义 Shell/Batch 脚本。
    2.  `update_repo`: 执行指定仓库的 `git pull` / `git fetch`。
    3.  `sync_route`: 执行指定的**同步路线** (Route)，搬运文件。
    4.  `commit_repo`: 对指定仓库执行 `git add .` + `git commit` + `git push`。
- **调度**：
    - 每个任务可配置独立的 `cron_expression`。
    - 支持手动立即触发。

### 4️⃣ 差异比对引擎 (FileDiff Engine)
- 独立于同步流程，随时可调用。
- 计算源与目标之间的文件差异（Hash + 行级 Diff）。

---

## 🧰 五、数据库设计 (Schema)

基于 SQLite。

### 1. 基础配置
- **Settings**: 全局 KV 配置。
- **Schema Management**: 必须支持**基于实体的自动升级 (Auto-Migration)**。应用启动时检查代码中的 Entity 定义与数据库表结构的差异，并自动应用变更（Code-First 模式）。

### 2. 仓库系统
```sql
-- [Restored] 仓库分组
CREATE TABLE repo_groups (
    id TEXT PRIMARY KEY,
    parent_id TEXT REFERENCES repo_groups(id), -- 支持嵌套
    name TEXT NOT NULL,
    sort_order INTEGER DEFAULT 0
);

-- 仓库定义 (关联 Group)
CREATE TABLE repositories (
    id TEXT PRIMARY KEY,
    group_id TEXT REFERENCES repo_groups(id), -- 可选归属
    name TEXT NOT NULL,
    local_path TEXT NOT NULL,
    remote_url TEXT,
    branch TEXT DEFAULT 'main',
    auth_type TEXT DEFAULT 'none',
    auth_username TEXT,
    auth_secret TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 3. 路线系统
```sql
-- [Restored] 路线分组
CREATE TABLE route_groups (
    id TEXT PRIMARY KEY,
    parent_id TEXT REFERENCES route_groups(id),
    name TEXT NOT NULL,
    sort_order INTEGER DEFAULT 0
);

-- 同步路线 (关联 Group)
CREATE TABLE routes (
    id TEXT PRIMARY KEY,
    group_id TEXT REFERENCES route_groups(id), -- 可选归属
    name TEXT NOT NULL,
    description TEXT,
    main_repo_id TEXT REFERENCES repositories(id),
    slave_repo_id TEXT REFERENCES repositories(id),
    
    last_sync_status TEXT,
    last_sync_time DATETIME,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 4. 任务编排系统
```sql
-- 任务定义
CREATE TABLE tasks (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    cron_expression TEXT,
    enabled BOOLEAN DEFAULT 1,
    last_run_status TEXT,
    last_run_time DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 任务步骤
CREATE TABLE task_steps (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id TEXT REFERENCES tasks(id),
    step_order INTEGER NOT NULL,
    action_type TEXT NOT NULL,
    target_id TEXT,
    params JSON
);
```

### 5. 日志系统
```sql
-- 任务执行日志
CREATE TABLE task_execution_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id TEXT REFERENCES tasks(id),
    start_time DATETIME,
    end_time DATETIME,
    status TEXT,
    output_log TEXT
);
```

---

## 🪜 六、开发路线图 (Roadmap)

| 阶段        | 目标                  | 核心任务                                                        |
| ----------- | --------------------- | --------------------------------------------------------------- |
| **Phase 1** | **Core Framework**    | 初始化 Tauri v2 项目，搭建 Rust (Win7 Compat) + SQLite 基础架构 |
| **Phase 2** | **Base Modules**      | 实现 Repo/Route 及其**分组管理**的增删改查逻辑 (Rust + UI)      |
| **Phase 3** | **Task Orchestrator** | 实现任务编排引擎、步骤执行逻辑、Cron 调度集成                   |
| **Phase 4** | **Sync & Diff**       | 实现文件 Diff 算法、搬运逻辑，并作为 Task 的一个 Step 被调用    |
| **Phase 5** | **Polish**            | 日志查看、系统托盘、Win7 兼容性测试                             |

---

## 🗂 七、项目结构建议

```bash
SourceBridge/
├── src-tauri/
│   ├── src/
│   │   ├── core/
│   │   │   ├── orchestrator/ # Task Logic
│   │   │   ├── git/          # Git Wrappers
│   │   │   ├── sync/         # Sync Logic
│   │   │   └── db/           # Repos, Groups, Routes tables
...
```
